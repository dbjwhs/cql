#!/bin/bash
# MIT License  
# Copyright (c) 2025 dbjwhs

# Pre-commit hook to enforce EOF newlines on all committed files
# This hook uses the check_eof_newline.py script to ensure all text files
# end with a newline character, which is a POSIX standard requirement.

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the directory containing this script
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$HOOK_DIR/../.." && pwd)"
EOF_CHECKER="$PROJECT_ROOT/scripts/check_eof_newline.py"

echo -e "${BLUE}🔍 Pre-commit: Checking EOF newlines...${NC}"

# Check if the EOF checker script exists
if [ ! -f "$EOF_CHECKER" ]; then
    echo -e "${RED}❌ Error: EOF newline checker not found at $EOF_CHECKER${NC}"
    echo -e "${YELLOW}💡 This hook requires the check_eof_newline.py script to be present.${NC}"
    exit 1
fi

# Check if Python 3 is available
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}❌ Error: Python 3 is required for the EOF newline checker${NC}"
    exit 1
fi

# Get list of staged files (only text files that should be checked)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}✅ No staged files to check${NC}"
    exit 0
fi

# Create a temporary file with the list of staged files
TEMP_FILE=$(mktemp)
trap "rm -f $TEMP_FILE" EXIT

# Filter to only include files that exist (not deleted)
for file in $STAGED_FILES; do
    if [ -f "$PROJECT_ROOT/$file" ]; then
        echo "$file" >> "$TEMP_FILE"
    fi
done

# Check if we have any files to process
if [ ! -s "$TEMP_FILE" ]; then
    echo -e "${GREEN}✅ No text files to check${NC}"
    exit 0
fi

# Run the EOF newline checker on staged files
echo -e "${BLUE}📋 Checking $(wc -l < "$TEMP_FILE") staged files...${NC}"

if python3 "$EOF_CHECKER" --check --filter-from-file "$TEMP_FILE" --quiet; then
    echo -e "${GREEN}✅ All staged files have proper EOF newlines${NC}"
    exit 0
else
    echo -e "${RED}❌ Some staged files are missing EOF newlines${NC}"
    echo
    echo -e "${YELLOW}💡 To fix this issue, you can:${NC}"
    echo -e "${YELLOW}   1. Fix automatically: python3 scripts/check_eof_newline.py --fix --filter-from-file $TEMP_FILE${NC}"
    echo -e "${YELLOW}   2. Fix with backup:   python3 scripts/check_eof_newline.py --fix --backup --filter-from-file $TEMP_FILE${NC}"
    echo -e "${YELLOW}   3. Then re-stage:      git add -u${NC}"
    echo
    echo -e "${BLUE}ℹ️  This hook enforces the POSIX standard requiring newlines at end of text files.${NC}"
    echo -e "${BLUE}   This ensures compatibility with Unix tools and proper file handling.${NC}"
    exit 1
fi
